{{>header}}

<div style="display:flex; justify-content:center; align-items:flex-start; padding-top:40px;">
    <div style="background:black; padding:20px; border-radius:10px; box-shadow:0px 0px 10px rgba(0, 0, 0, 0.1); width:600px; color:white; font-family:monospace;">
        <h2 style="text-align:center;">ğŸ’» UNIX ëª…ë ¹ì–´ ì‹¤í–‰</h2>

        <form id="command-form">
            <input type="text" id="command" name="command" placeholder="ëª…ë ¹ì–´ ì…ë ¥ í›„ Enter"
                   list="command-suggestions"
                   style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; background:#222; color:#0f0; font-weight:bold;">
            <datalist id="command-suggestions"></datalist>
        </form>

        <!-- âœ… ì¶”ì²œ ëª…ë ¹ì–´ í‘œì‹œ -->
        <div id="suggestion-box" style="margin-top:10px; color: #aaa;"></div>

        <!-- âœ… ì‹¤í–‰ ê¸°ë¡ ì´ˆê¸°í™” ë²„íŠ¼ -->
        <button id="clear-history" style="margin-top:10px; background:red; color:white; border:none; padding:5px 10px; cursor:pointer;">
            ğŸ—‘ ì‹¤í–‰ ê¸°ë¡ ì´ˆê¸°í™”
        </button>

        <div id="output" style="background:#111; padding:10px; margin-top:10px; border-radius:5px; height:400px; overflow-y:auto;">
            {{#historyList}}
                <p class="command-text">$ {{command}}</p>
                <pre class="command-output">{{result}}</pre>
            {{/historyList}}
        </div>

        <!-- âœ… ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ê·¸ë˜í”„ -->
        <canvas id="disk-usage-chart"
                style="width: 100%; max-width: 400px; max-height: 200px; background:#222; border-radius:5px; padding:10px; display: none;">
        </canvas>
    </div>
</div>

{{>footer}}

<style>
    .command-text { color: #0f0; font-weight: bold; }
    .command-output { color: white; white-space: pre-wrap; word-wrap: break-word; }
    .directory { color: #00f; font-weight: bold; } /* âœ… ë””ë ‰í† ë¦¬ëŠ” íŒŒë€ìƒ‰ */
    .file { color: #fff; } /* âœ… ì¼ë°˜ íŒŒì¼ì€ í°ìƒ‰ */
    .error { color: red; font-weight: bold; } /* âœ… ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” ë¹¨ê°„ìƒ‰ */
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // âœ… ëª…ë ¹ì–´ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸
    const commandRecommendations = {
        "ls": ["ls -l (ë” ìì„¸í•œ ì •ë³´ ë³´ê¸°)", "du -sh * (ê° íŒŒì¼ì˜ ìš©ëŸ‰ í™•ì¸)"],
        "cd": ["cd .. (ìƒìœ„ ë””ë ‰í† ë¦¬ ì´ë™)", "cd /var/log (ë¡œê·¸ í´ë” ì´ë™)"],
        "rm": ["rm -rf (ê°•ì œ ì‚­ì œ)", "trash-put (macOSì—ì„œ ì•ˆì „ ì‚­ì œ)"],
        "chmod": ["chmod 755 (íŒŒì¼ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬)", "chmod -R 777 (í´ë” ê¶Œí•œ ë³€ê²½)"],
        "df": ["df -h (ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸)", "du -sh * (í´ë”ë³„ ìš©ëŸ‰ í™•ì¸)"]
    };

    document.getElementById("command").addEventListener("input", function () {
        let input = this.value.trim();
        let suggestionBox = document.getElementById("suggestion-box");

        if (commandRecommendations[input]) {
            suggestionBox.innerHTML = "<strong>ğŸ”¹ ì¶”ì²œ:</strong> " + commandRecommendations[input].join(" | ");
        } else {
            suggestionBox.innerHTML = "";
        }
    });

    // âœ… ì‹¤í–‰ ê¸°ë¡ ì´ˆê¸°í™” ê¸°ëŠ¥ (ì„œë²„ & UI ë™ê¸°í™”)
    document.getElementById("clear-history").onclick = async function () {
        try {
            let response = await fetch("/seoultechUnix/command/clear", {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            });

            if (!response.ok) throw new Error("âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + response.status);

            let result = await response.text();
            alert(result); // âœ… ì´ˆê¸°í™” ì„±ê³µ ë©”ì‹œì§€

            // âœ… UIì—ì„œë„ ì‹¤í–‰ ê¸°ë¡ ì‚­ì œ
            document.getElementById("output").innerHTML = "";
            // âœ… ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ê·¸ë˜í”„ ìˆ¨ê¸°ê¸°
            document.getElementById("disk-usage-chart").style.display = "none";
            console.log("âœ… í´ë¼ì´ì–¸íŠ¸ UIì—ì„œ ì‹¤í–‰ ê¸°ë¡ ì´ˆê¸°í™” ì™„ë£Œ!");

        } catch (error) {
            console.error("âŒ ì‹¤í–‰ ê¸°ë¡ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("âŒ ì‹¤í–‰ ê¸°ë¡ ì´ˆê¸°í™” ì‹¤íŒ¨!");
        }
    };

    // âœ… ëª…ë ¹ì–´ ì‹¤í–‰ ì²˜ë¦¬
    // âœ… ëª…ë ¹ì–´ ì‹¤í–‰ ì²˜ë¦¬
    // âœ… ëª…ë ¹ì–´ ì‹¤í–‰ ì²˜ë¦¬
    document.getElementById("command-form").onsubmit = async function(event) {
        event.preventDefault();
        let commandInput = document.getElementById("command");
        let command = commandInput.value.trim();
        if (!command) return;

        let outputDiv = document.getElementById("output");

        // âœ… ì‚¬ìš©ìê°€ ì…ë ¥í•œ ëª…ë ¹ì–´ ì¶”ê°€
        let newCommand = document.createElement("p");
        newCommand.className = "command-text";
        newCommand.innerHTML = "$ " + command;
        outputDiv.appendChild(newCommand);

        try {
            let response = await fetch("/kmcplace/command/execute", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "command=" + encodeURIComponent(command),
                cache: "no-cache"
            });

            if (!response.ok) throw new Error(`âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status} ${response.statusText}`);

            let result = await response.json();
            console.log("ğŸ“Œ ì„œë²„ ì‘ë‹µ ì›ë³¸:", result);

            // âœ… ğŸ”¥ colorizeOutput ì ìš©
            let pre = document.createElement("pre");
            pre.className = "command-output";
            pre.innerHTML = colorizeOutput(result.join("\n")); // âœ… ìƒ‰ìƒ ì ìš©
            outputDiv.appendChild(pre);

            // âœ… df -h ì‹¤í–‰ ì‹œ ê·¸ë˜í”„ í‘œì‹œ
            if (command === "df -h") {
                drawDiskUsageGraph(result);
            }

            outputDiv.scrollTop = outputDiv.scrollHeight;

        } catch (error) {
            console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
            let errorMessage = document.createElement("p");
            errorMessage.className = "command-output error";
            errorMessage.textContent = "âŒ ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            outputDiv.appendChild(errorMessage);
        }

        commandInput.value = "";
    };

    // âœ… ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ê·¸ë˜í”„ ìƒì„± í•¨ìˆ˜
    function drawDiskUsageGraph(dfOutput) {
        let labels = [];
        let usedData = [];
        let freeData = [];

        dfOutput.forEach(line => {
            let parts = line.split(/\s+/);
            if (parts.length >= 6 && parts[0].startsWith("/dev/")) {
                labels.push(parts[0]);  // âœ… ë””ìŠ¤í¬ ì´ë¦„
                usedData.push(parseFloat(parts[2].replace("G", ""))); // âœ… ì‚¬ìš©ëœ ê³µê°„
                freeData.push(parseFloat(parts[3].replace("G", ""))); // âœ… ë‚¨ì€ ê³µê°„
            }
        });

        let ctx = document.getElementById("disk-usage-chart").getContext("2d");
        document.getElementById("disk-usage-chart").style.display = "block";

        new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [
                    { label: "ì‚¬ìš©ëœ ê³µê°„ (GB)", data: usedData, backgroundColor: "red" },
                    { label: "ë‚¨ì€ ê³µê°„ (GB)", data: freeData, backgroundColor: "green" }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, aspectRatio: 2 }
        });
    }
    // âœ… ğŸ”¥ ëª…ë ¹ì–´ ì‹¤í–‰ ê²°ê³¼ ìƒ‰ìƒ ì ìš© (ë””ë ‰í† ë¦¬/íŒŒì¼/ì˜¤ë¥˜ êµ¬ë¶„)
    function colorizeOutput(output) {
        return output
                .split("\n") // ì¤„ ë‹¨ìœ„ë¡œ ë‚˜ëˆ”
                .map(line => {
                    if (/^d[\w-]+@?\s+/.test(line)) {
                        return `<span class="directory">${line}</span>`; // âœ… ë””ë ‰í† ë¦¬ (íŒŒë€ìƒ‰)
                    }
                    if (/^-[rwxsStT-]+@?\s+/.test(line)) {
                        return `<span class="file">${line}</span>`; // âœ… íŒŒì¼ (í°ìƒ‰)
                    }
                    if (/(error|not found|denied|No such file or directory)/gi.test(line)) {
                        return `<span class="error">${line}</span>`; // âœ… ì˜¤ë¥˜ ë©”ì‹œì§€ (ë¹¨ê°„ìƒ‰)
                    }
                    return line; // âœ… ë‚˜ë¨¸ì§€ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
                })
                .join("<br>"); // âœ… ì¤„ë°”ê¿ˆì„ <br> íƒœê·¸ë¡œ ë³€í™˜í•˜ì—¬ ìœ ì§€
    }

</script>
