{{>header}}

<style>
    .chat-container {
        display: flex;
        height: 80vh;
        font-family: sans-serif;
    }

    .user-list {
        width: 250px;
        background: #f4f4f4;
        border-right: 1px solid #ccc;
        padding: 15px;
        overflow-y: auto;
    }

    .user-list h4 {
        margin-bottom: 10px;
    }

    .user-list ul {
        list-style: none;
        padding: 0;
    }

    .user-list li {
        padding: 8px 10px;
        margin-bottom: 5px;
        background-color: #e1e1e1;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .user-list li:hover {
        background-color: #d1d1d1;
    }

    .chat-window {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .chat-box {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #fff;
        border-bottom: 1px solid #ccc;
    }

    .chat-message {
        margin: 5px 0;
    }

    .chat-message.self {
        text-align: right;
        color: #3498db;
    }

    .chat-message.other {
        text-align: left;
        color: #2c3e50;
    }

    .input-area {
        display: flex;
        padding: 10px;
    }

    .input-area input {
        flex: 1;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-right: 10px;
    }

    .input-area button {
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .input-area button:hover {
        background-color: #2980b9;
    }
</style>

<div class="chat-container">
    <!-- ÏÇ¨Ïö©Ïûê Î™©Î°ù -->
    <div class="user-list">
        <h4>üü¢ Ï†ëÏÜç Ï§ë</h4>
        <ul id="users"></ul>
    </div>

    <!-- Ï±ÑÌåÖ ÏòÅÏó≠ -->
    <div class="chat-window">
        <div id="chat-box" class="chat-box"></div>
        <div class="input-area">
            <!-- input Î∂ÄÎ∂Ñ ÏàòÏ†ï -->
            <input type="text" id="msg" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" onkeyup="checkEnter(event)">

            <button type="button" onclick="sendMessage()">Ï†ÑÏÜ°</button>

        </div>
    </div>
</div>

<script>
    let selectedUser = null;
    let selectedUserId = null;
    let ws = new WebSocket("ws://" + location.host + "/ws/chat");

    // WebSocket ÏàòÏã† Ïù¥Î≤§Ìä∏
    ws.onmessage = function (event) {
        const data = JSON.parse(event.data);
        const box = document.getElementById("chat-box");

        const div = document.createElement("div");

        if (data.type === "self") {
            div.className = "chat-message self";
            div.innerText = "ÎÇò: " + data.text;
        } else if (data.type === "other" && data.senderId === selectedUserId) {
            div.className = "chat-message other";
            div.innerText = data.nickname + ": " + data.text;
        } else {
            return; // ÏÑ†ÌÉùÎêú ÏÇ¨Ïö©ÏûêÏôÄ ÏÉÅÍ¥ÄÏóÜÎäî Î©îÏãúÏßÄÎäî Î¨¥Ïãú
        }

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    };

    function sendMessage() {
        const msgInput = document.getElementById("msg");
        const msg = msgInput.value.trim();

        if (!msg || !selectedUserId) return;

        // ÏïàÏ†ÑÌïòÍ≤å Ìïú Î≤à Îçî Î∞©ÏßÄ
        if (msg.length === 0) return;

        ws.send(selectedUserId + "|" + msg);
        msgInput.value = "";
    }
    function checkEnter(event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    function loadUsers() {
        fetch("/chat/users")
                .then(res => res.json())
                .then(users => {
                    const ul = document.getElementById("users");
                    ul.innerHTML = "";
                    users.forEach(user => {
                        const li = document.createElement("li");
                        li.textContent = user.nickname;
                        li.onclick = () => {
                            selectedUserId = user.id; // Ïã§Ï†ú Ï†ÑÏÜ°Ìï† username
                            selectedUser = user.nickname;

                            const box = document.getElementById("chat-box");
                            box.innerHTML = `<div class='chat-message'>üó®Ô∏è ${user.nickname}ÎãòÍ≥ºÏùò ÎåÄÌôî</div>`;

                            // ‚úÖ Í≥ºÍ±∞ Î©îÏãúÏßÄ Î∂àÎü¨Ïò§Í∏∞
                            fetch(`/chat/history?targetUser=${user.id}`)
                                    .then(res => res.json())
                                    .then(messages => {
                                        messages.forEach(msg => {
                                            const msgDiv = document.createElement("div");
                                            const isSelf = msg.sender === user.id ? "other" : "self";
                                            msgDiv.className = "chat-message " + isSelf;
                                            msgDiv.innerText = (isSelf === "self" ? "ÎÇò" : user.nickname) + ": " + msg.message;
                                            box.appendChild(msgDiv);
                                        });
                                        box.scrollTop = box.scrollHeight;
                                    });
                        };
                        ul.appendChild(li);
                    });
                });
    }

    window.onload = loadUsers;
</script>


{{>footer}}
